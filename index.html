<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <title>Vite App</title>
</head>

<body>
  <div class="container mt-5">
    <div class="drag-and-drop" x-data="{ 
      items: [],  
      languages: [ 'US', 'EN', 'JP', 'VN', 'GM'],
      initBsSelect (item) {
        $('#select-'+item.id).select2()
      },
      getNestedSortableCfg() {
        let items = this.items

        return {
          group: 'shared',
          animation: 150,
          onSort: (evt) => {
            if (evt.pullMode == true) {
              // Case move item from nested to outside
              if(evt.from.dataset.id) {
                
              } else {
                const changedItemIndex = items.findIndex(item => item.id == evt.item.dataset.id)
                let changedItem = items.splice(changedItemIndex,1)[0]
                // Move into parent node
                let parentNode = items.find(item => item.id == evt.to.dataset.id)
                if(parentNode.body){
                  parentNode.body.splice(evt.newIndex, 0, Alpine.raw(changedItem))
                } else {
                  parentNode.body = [Alpine.raw(changedItem)]
                }
              }

            }

            if (evt.pullMode == undefined && evt.type == 'sort') {

            }
          }
        }
      },
    }">
      <div class="drag-and-drop__container drag-and-drop__container--from">
        <h3 class="drag-and-drop__title">From</h3>
        <ul class="drag-and-drop__items" x-sort x-sort:config="{
            group: {
                name: 'shared',
                pull: 'clone',
                put: false // Do not allow items to be put into this list
            },
            animation: 150,
            sort: false, // To disable sorting: set sort to false
            onEnd: (evt) => {
              const item = $(evt.item)

              if(evt.pullMode === 'clone') {
                evt.item.remove()

                items.splice(evt.newIndex ,0 ,{
                  id: crypto.randomUUID(),
                  type: item.data('type'),
                  value: crypto.randomUUID()
                })
              }

              // Reset draged item style
              item.removeAttr('draggable').removeAttr('style')
            }
        }">
          <!-- loop through the items -->
          <li id="item-1" class="drag-and-drop__item" data-type="1">
            Your Item #1
          </li>
          <li id="item-2" class="drag-and-drop__item" data-type="2">
            Your Item #2
          </li>
          <li id="item-3" class="drag-and-drop__item" data-type="3">
            Your Item #3
          </li>
          <li id="item-4" class="drag-and-drop__item" data-type="4">
            Your Item #4
          </li>
          <li id="item-5" class="drag-and-drop__item" data-type="5">
            Your Item #5
          </li>
          <li id="item-6" class="drag-and-drop__item" data-type="6">
            Your Item #6
          </li>
        </ul>
      </div>
      <div class="drag-and-drop__divider">â‡„</div>
      <div class="drag-and-drop__container drag-and-drop__container--to">
        <h3 class="drag-and-drop__title">To</h3>
        <ul id="save2" class="drag-and-drop__items" x-sort x-sort:config="{
          group: 'shared',
          animation: 150,
          onSort: (evt) => {
            if(evt.pullMode == 'sort'){
              swapReactiveItems(items, evt.oldIndex, evt.newIndex)
            }
          }
        }">
          <template x-for="(item,index) in items" :key="item.id + index">
            <li class="drag-and-drop__item" :data-id="item.id">
              <template x-if="item.type == 1">
                <select :id="'select-'+item.id" name="lang" class="form-control" x-effect="initBsSelect(item)"
                  x-model="item.value">
                  <template x-for="(lang,index) in languages">
                    <option x-text="lang" :value="index"></option>
                  </template>
                </select>
              </template>

              <template x-if="item.type == 2">
                <span x-text="item.value"></span> 
              </template>

              <template x-if="item.type == 3">
                <ul class="drag-and-drop__items p-0" :data-id="item.id" x-sort x-sort:config="getNestedSortableCfg()">
                  <template x-for="child in item.body">
                    <li class="drag-and-drop__item" :data-id="child.id" x-text="child.value"></li>
                  </template>
                </ul>
              </template>

            </li>
          </template>
        </ul>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
      crossorigin="anonymous">
    </script>

    <script>
      /**
       * 
       * @param {HTMLElement} posA - Position A
       * @param {HTMLElement} posB - Position B
       **/ 
      function swapReactiveItems(arr, posA, posB) {
        const a = Alpine.raw(arr[posA]);
        const b = Alpine.raw(arr[posB]);
  
        arr[posB] = b
        arr[posA] = a
      }
    </script>
    <script type="module" src="/main.js"></script>
</body>

</html>